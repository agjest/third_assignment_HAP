---
title: "pendling"
format: html
editor: visual
---

```{r}
#| label: setup
#| echo: false
#| message: false
library(tidyverse)
library(tidyselect)
library(lubridate)
library(PxWebApiData)
library(flextable)
library(magrittr)
```

## Intro

-   Henter API fra SSB

-   Lager pivots

-   Lager pendlermatrise / origin-destination

-   Bruk char vector, gjør om til faktor variabel, slå i sammen mangen av kategorier til breiere kategorier

-   Viktig teknikk:

-   Important technique:

-   Make factor of a variable.

-   Collapse the levels into groups we are interested in and throw the rest into an "Other" category.

-   Alternative to case_when()

```         
From \<<https://msb105.netlify.app/wrangle-data/factors/factors#/factors-in-tidyverse-forcats>\>
```

## SSB

```{r}
#Get more info about table
ApiData(
"http://data.ssb.no/api/v0/en/table/03321",
returnApiQuery = TRUE
) 
```

```{r}
metadata_03321 <- ApiData12(
  "https://data.ssb.no/api/v0/no/table/03321/",
  returnMetaFrames = TRUE
  )
```

```{r}
#Vi laster inn en API med alle som har arbeidssted Haugaland
pend_00_22_ssb_arbHland <- ApiData12(
  "https://data.ssb.no/api/v0/no/table/03321/",
  Bokommuen = list("*"),
  # ag: Vi må ha med gamle Sveio og Etne  1211, 1216
  ArbstedKomm = c("1106", "1135", "1145", "1146", "1149", "1154",
                  "1159", "1160", "4611", "4612", "1211", "1216"),
  Tid = c(paste(
    as.character(2000:2022),
    #sep betyr at det ikke skal være mellomrom mellom elementene
    sep = "")
    )
  )
```

```{r}
#Vi laster inn en API med alle som har bosted Haugaland
#| cache: true
pend_00_22_ssb_boHland <- ApiData12(
  "https://data.ssb.no/api/v0/no/table/03321/",
  ArbstedKomm = list("*"),
   # ag: Vi må ha med gamle Sveio og Etne  1211, 1216
  Bokommuen = c("1106", "1135", "1145", "1146", "1149", "1154", 
                "1159", "1160", "4611", "4612", "1211", "1216"),
  Tid = c(paste(
    as.character(2000:2022),
    sep = "")
    )
  )
```

```{r}
names(pend_00_22_ssb_arbHland)
```

```{r}
# Vi gir variablene nytt navn
names(pend_00_22_ssb_arbHland) <- c(
  "arb_kom",
  "bo_kom",
  "statistikkvariabel",
  "aar",
  "arb_komnr",
  "bo_komnr",
  "ContentsCode",
  "Tid",
  "pendlere"
)
```

```{r}
# Vi gir variablene nytt navn
names(pend_00_22_ssb_boHland) <- c(
  "arb_kom",
  "bo_kom",
  "statistikkvariabel",
  "aar",
  "arb_komnr",
  "bo_komnr",
  "ContentsCode",
  "Tid",
  "pendlere"
)
```

```{r}
pend_00_22_ssb_arbHland <- pend_00_22_ssb_arbHland %>% 
  select(aar, arb_kom, bo_kom, pendlere)
```

```{r}
pend_00_22_ssb_boHland <- pend_00_22_ssb_boHland %>% 
  select(aar, bo_kom, arb_kom, pendlere)
```

```{r}
pend_00_22_ssb_arbHland <- pend_00_22_ssb_arbHland |> 
  # ag: Overskriver arb_kom med en faktor variant
  # vi trenger ikke både en faktor variabel og den samme som
  # ikke faktor
  mutate(
    arb_kom = fct(arb_kom),
    bo_kom = fct(bo_kom))
```

```{r}
pend_00_22_ssb_boHland <- pend_00_22_ssb_boHland |> 
  mutate(
    arb_kom = fct(arb_kom),
    bo_kom = fct(bo_kom))
```

Vi slår sammen kategoriene til Haugesund, Sauda, Bokn, Tysvær, Karmøy, Vinafjord og Ølen.

```{r}
#collapset bokommune
# ag: vi må også kollapse arb_kom til de 8 kom. på Haugalandet
pend_00_22_arbHland <- pend_00_22_ssb_arbHland |> 
  mutate(
    # ag: her skal det ikke være noen andre kategori
    arb_kom = fct_collapse(
      .f = arb_kom,
      "Haugesund" = "Haugesund",
      "Karmøy" = "Karmøy",
      "Bokn" = "Bokn",
      "Tysvær" = "Tysvær",
      "Sveio" = c("Sveio", "Sveio (-2019)"),
      "Sauda" = "Sauda",
      "Etne" = c("Etne", "Etne (-2019)"),
      "Vindafjord" = c("Ølen (2002-2005)", "Vindafjord", "Vindafjord (1965-2005)")    ),   
    # ag: Her trenger vi en andre kategori
    bo_kom = fct_collapse(
      .f = bo_kom,
      "Haugesund" = "Haugesund",
      "Karmøy" = "Karmøy",
      "Bokn" = "Bokn",
      "Tysvær" = "Tysvær",
      "Sveio" = c("Sveio", "Sveio (-2019)"),
      "Sauda" = "Sauda",
      "Etne" = c("Etne", "Etne (-2019)"),
      "Vindafjord" = c("Ølen (2002-2005)", "Vindafjord", "Vindafjord (1965-2005)"),
      other_level = "Andre"
    )
  )
```

```{r}
#collapset arbeidskommune
pend_00_22_boHland <- pend_00_22_ssb_boHland |> 
  mutate(
    # ag: her skal det ikke være noen andre kategori. Overskriver bo_kom_fac
    bo_kom = fct_collapse(
      .f = bo_kom,
      "Haugesund" = "Haugesund",
      "Karmøy" = "Karmøy",
      "Bokn" = "Bokn",
      "Tysvær" = "Tysvær",
      "Sveio" = c("Sveio", "Sveio (-2019)"),
      "Sauda" = "Sauda",
      "Etne" = c("Etne", "Etne (-2019)"),
      "Vindafjord" = c("Ølen (2002-2005)", "Vindafjord", "Vindafjord (1965-2005)")
    ),  
    # ag: Her trenger vi en andre kategori. Overskriver arb_kom_fac 
    arb_kom = fct_collapse(
      .f = arb_kom,
      "Haugesund" = "Haugesund",
      "Karmøy" = "Karmøy",
      "Bokn" = "Bokn",
      "Tysvær" = "Tysvær",
      "Sveio" = c("Sveio", "Sveio (-2019)"),
      "Sauda" = "Sauda",
      "Etne" = c("Etne", "Etne (-2019)"),
      "Vindafjord" = c("Ølen (2002-2005)", "Vindafjord", "Vindafjord (1965-2005)"),
      other_level = "Andre"
    )
  ) |> 
  select(aar, bo_kom, arb_kom, pendlere)
```

```{r}
#guperer på aar, arb_kom og bo_kom
pend_00_22_arbHland <- pend_00_22_arbHland  |> 
  # ag: trenger ikke filtrere
  # filter(pend_00_22_ssb_arbHland, pendlere > 0) |> 
  group_by(aar, bo_kom, arb_kom) |>
  summarise(pendlere = sum(pendlere),
    .groups = "drop")
```

```{r}
pend_00_22_arbHland |>
  head(5)
```

```{r}
#gruppert med aar, arb_kom og bo_kom
pend_00_22_boHland <- pend_00_22_boHland  |> 
  # ag: trenger ikke filtrere
  # filter(pend_00_22_ssb_boHland, pendlere > 0) |> 
  group_by(aar, arb_kom, bo_kom) |>
  summarise(pendlere = sum(pendlere),
    .groups = "drop")
```

```{r}
pend_00_22_boHland |>
  head(5)
```

```{r}
dim(pend_00_22_ssb_arbHland)
```

```{r}
# Nå skal vi joine begge listene
# Endrer fra ssb variant til bearbeidet variant
pmat_long <- pend_00_22_arbHland |>  
  full_join(pend_00_22_boHland,
            by = join_by(aar, bo_kom, arb_kom, pendlere)) |>
  # endrer arb_kom og bo_kom fra faktor til character
   mutate(
    arb_kom = as.character(arb_kom),
    bo_kom = as.character(bo_kom)
  ) |>  
  ungroup()
```

```{r}
pmat_long |> head(10)
```

```{r}
dim(pmat_long)
```

```{r}
# vi skal nå finne andelen av de som jobber i andre kommuner
pmat_long <- pmat_long %>%
group_by(bo_kom, aar) %>%
  mutate(total_bo_kom = sum(pendlere),
       bo_percent = round((pendlere / total_bo_kom) * 100, 1)
       ) %>%
ungroup() %>%
group_by(arb_kom, aar) %>%
  mutate(total_arb_kom = sum(pendlere), 
  arb_percent = round((pendlere / total_arb_kom) * 100, 1)
  ) %>%
ungroup() %>%
select(-total_bo_kom, -total_arb_kom)
```

```{r}
dim(pmat_long)
```

## Pendlermatrise år 2000

```{r}
# Nå skal vi endre rekkefølge i kommune og kolonner
ordKom <- c("bo_kom", "Haugesund", "Karmøy", "Tysvær", "Sveio", "Bokn", "Vindafjord", "Sauda", "Etne", "Andre")
```

```{r}
# pendlermatrise år 2000 for de som bor 
p2000bo <- pmat_long |>
  filter(aar == 2000) |>
  select(bo_kom, arb_kom, pendlere) |>
  pivot_wider(names_from = arb_kom, values_from = pendlere) |>
  mutate(bo_kom = factor(bo_kom, levels = ordKom)) |>
  arrange(bo_kom) |>
  select("bo_kom", all_of(ordKom)) |>
  rename("Bo kom.\\ Arb. kom." = bo_kom) |>
```

```{r}
# her lager vi en finere matrise
#| label: tbl-p2000
#| tbl-cap: "Pendlematrise for Haugalandet år 2000."
p2000bo |> 
  flextable() |> 
  # a4 8.268 in - 1 in left margin - 1 in right margin = 6.268 in
  fit_to_width(max_width = 6.268, inc = 1L, max_iter = 20, unit = "in") |> 
  line_spacing(space = 0,
              part = "body"
              ) %>% 
  hrule(rule = "exact")  %>% 
  height_all(height = 5, part = "all", unit = "mm") |> 
  padding(padding.top = 1, padding.bottom = 2, part = "all") %>% 
  theme_booktabs()

```

```{r}
# pendlermatrise år 2000 for de som bor 
p2000arb <- pmat_long |>
  filter(aar == 2000) |>
  select(bo_kom, arb_kom, pendlere) |>
  pivot_wider(names_from = bo_kom, values_from = pendlere) |>
  mutate(arb_kom = factor(arb_kom, levels = ordKom)) |>
  arrange(arb_kom) |>
  select("arb_kom", all_of(ordKom)) |>
  rename("Arb kom.\\ Bo kom." = arb_kom) |>
```

```{r}
#| label: tbl-p2000
#| tbl-cap: "Pendlematrise for Haugalandet år 2000."
p2000arb |> 
  flextable() |> 
  # a4 8.268 in - 1 in left margin - 1 in right margin = 6.268 in
  fit_to_width(max_width = 6.268, inc = 1L, max_iter = 20, unit = "in") |> 
  line_spacing(space = 0,
              part = "body"
              ) %>% 
  hrule(rule = "exact")  %>% 
  height_all(height = 5, part = "all", unit = "mm") |> 
  padding(padding.top = 1, padding.bottom = 2, part = "all") %>% 
  theme_booktabs()
```

1.  I år 2000 var det 121 personer som bodde i Haugesund og arbeidet i Vindafjord
2.  I år 2000 var det 0 personer som bodde i Boken og arbeidet i Sveio
3.  I år 2000 var andelen som bodde i Kamøy og jobbet i Bokn 0,1 %
4.  I år 2000 var andelen som bodde i Bokn og jobbet i Karmøy 4,3 %
5.  I år 2000 var andelen som bodde i Haugesund og jobbet i Sveio 0,7 %
6.  I år 2000 var andelen som bodde i Tysvær og jobbet i Sveio 0,4 %
7.  I år 2000 var andelen som bodde i Vindafjord og jobbet i Haugesund 8,2 %

## Pendlermatrise år 2012

## Pendlermatrise år 2022

## Tidy

## Spørsmål

## Oppgave

## Konklusjon

## Referanser
